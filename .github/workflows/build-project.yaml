name: Build Project
on:
  workflow_call:
    outputs:
      pluginName:
        description: Project name detected by parsing build spec file
        value: ${{ jobs.check-event.outputs.pluginName }}
permissions:
  packages: write
jobs:
  check-event:
    name: Check GitHub Event Data ðŸ”Ž
    runs-on: ubuntu-24.04
    defaults:
      run:
        shell: bash
    outputs:
      package: ${{ steps.setup.outputs.package }}
      codesign: ${{ steps.setup.outputs.codesign }}
      notarize: ${{ steps.setup.outputs.notarize }}
      config: ${{ steps.setup.outputs.config }}
      commitHash: ${{ steps.setup.outputs.commitHash }}
      pluginName: ${{ steps.setup.outputs.pluginName }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Check Event Data â˜‘ï¸
        id: setup
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi

          case "${GITHUB_EVENT_NAME}" in
            pull_request)
              config_data=('codesign:false' 'notarize:false' 'package:false' 'config:RelWithDebInfo')
              if gh pr view ${{ github.event.number }} --json labels \
                | jq -e -r '.labels[] | select(.name == "Seeking Testers")' > /dev/null; then
                config_data[0]='codesign:true'
                config_data[2]='package:true'
              fi
              ;;
            push)
              config_data=('codesign:true' 'notarize:false' 'package:true' 'config:RelWithDebInfo')
              if [[ ${GITHUB_REF_NAME} =~ [0-9]+.[0-9]+.[0-9]+(-(rc|beta).+)? ]]; then
                config_data[1]='notarize:true'
                config_data[3]='config:Release'
              fi
              ;;
            workflow_dispatch)
              config_data=('codesign:true' 'notarize:false' 'package:false' 'config:RelWithDebInfo')
              ;;
            schedule)
              config_data=('codesign:true' 'notarize:false' 'package:true' 'config:RelWithDebInfo')
              ;;
            *) ;;
          esac

          for config in "${config_data[@]}"; do
            IFS=':' read -r key value <<< "${config}"
            echo "${key}=${value}" >> $GITHUB_OUTPUT
          done
          echo "commitHash=${GITHUB_SHA:0:9}" >> $GITHUB_OUTPUT

          plugin_name="$(grep 'name' buildspec.json | sed -E -e 's/^.+"name":[^"]+"(.+)",?$/\1/g')"
          plugin_display_name="$(grep 'displayName' buildspec.json | sed -E -e 's/^.+"displayName":[^"]+"(.+)",?$/\1/g' || echo "")"

          if [[ "${plugin_display_name}" ]]; then
            echo "pluginName=${plugin_display_name}" >> $GITHUB_OUTPUT
          else
            echo "pluginName=${plugin_name}" >> $GITHUB_OUTPUT
          fi

  macos-build:
    name: Build for macOS ðŸ
    runs-on: macos-15
    needs: check-event
    env: 
      USERNAME: bkpeterson
      VCPKG_EXE: /usr/local/share/vcpkg/vcpkg
      FEED_URL: https://nuget.pkg.github.com/bkpeterson/index.json
      VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/bkpeterson/index.json,readwrite"
    defaults:
      run:
        shell: zsh --no-rcs --errexit --pipefail {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set Up VCPKG ðŸ”§
        run: |
          /usr/local/share/vcpkg/bootstrap-vcpkg.sh
          vcpkg integrate install

          echo "VCPKG_ROOT=/usr/local/share/vcpkg" >> $GITHUB_ENV

          brew install autoconf autoconf-archive automake libtool mono nuget

          nuget sources add -Source "${{ env.FEED_URL }}" -StorePasswordInClearText -Name GitHubPackages -UserName "${{ env.USERNAME }}" -Password "${{ secrets.GITHUB_TOKEN }}"
          nuget setapikey "${{ secrets.GITHUB_TOKEN }}" -Source "${{ env.FEED_URL }}"

          vcpkg install pango

          ls /usr/local/share/vcpkg/installed/arm64-osx

          echo "**************"

          ls /usr/local/share/vcpkg/installed/vcpkg

#      - name: Set Up Environment ðŸ”§
#        id: setup
#        run: |
#          if (( ${+RUNNER_DEBUG} )) setopt XTRACE
#
#          print '::group::Enable Xcode 16.1'
#          sudo xcode-select --switch /Applications/Xcode_16.1.0.app/Contents/Developer
#          print '::endgroup::'
#
#          print '::group::Clean Homebrew Environment'
#          local -a unwanted_formulas=()
#          local -a remove_formulas=()
#          for formula (${unwanted_formulas}) {
#            if [[ -d ${HOMEBREW_PREFIX}/Cellar/${formula} ]] remove_formulas+=(${formula})
#          }
#
#          if (( #remove_formulas )) brew uninstall --ignore-dependencies ${remove_formulas}
#          print '::endgroup::'
#
#          local product_name
#          local product_version
#          read -r product_name product_version <<< \
#            "$(jq -r '. | {name, version} | join(" ")' buildspec.json)"
#
#          print "pluginName=${product_name}" >> $GITHUB_OUTPUT
#          print "pluginVersion=${product_version}" >> $GITHUB_OUTPUT
#
#      - name: Install Pango dependencies
#        if: runner.os == 'macOS'
#        run: |
#          brew install pango
#
#      - name: Set Homebrew Library Path
#        run: |
#          echo "LIBRARY_PATH=/opt/homebrew/lib" >> $GITHUB_ENV
#  
#      - name: Install Rosetta 2 
#        run: |
#          softwareupdate --install-rosetta --agree-to-license
#
#      - name: Install x86 Homebrew and Pango
#        run: |
#          # The system's default Homebrew (/opt/homebrew) is for ARM64.
#          # We must install a separate, dedicated version for x86_64.
#          # This command installs x86_64 Homebrew to /usr/local.
#          arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
#
#          # Install Pango and its dependencies using the x86_64 Homebrew.
#          # The arch -x86_64 prefix forces the command to run via Rosetta.
#          arch -x86_64 /usr/local/bin/brew install pango
#
#      - name: Create Universal Pango Libraries
#        run: |
#          mv /opt/homebrew/Cellar/cairo/1.18.4/lib/libcairo.2.dylib /opt/homebrew/Cellar/cairo/1.18.4/lib/libcairo.2.arm64.dylib
#          lipo -create /usr/local/lib/libcairo.2.dylib /opt/homebrew/Cellar/cairo/1.18.4/lib/libcairo.2.arm64.dylib -output /opt/homebrew/Cellar/cairo/1.18.4/lib/libcairo.2.dylib
#
#          mv /opt/homebrew/Cellar/pango/1.57.0/lib/libpango-1.0.0.dylib /opt/homebrew/Cellar/pango/1.57.0/lib/libpango-1.0.0.arm64.dylib
#          lipo -create /usr/local/lib/libpango-1.0.0.dylib /opt/homebrew/Cellar/pango/1.57.0/lib/libpango-1.0.0.arm64.dylib -output /opt/homebrew/Cellar/pango/1.57.0/lib/libpango-1.0.0.dylib
#
#          mv /opt/homebrew/Cellar/harfbuzz/11.5.1/lib/libharfbuzz.0.dylib /opt/homebrew/Cellar/harfbuzz/11.5.1/lib/libharfbuzz.0.arm64.dylib
#          lipo -create /usr/local/lib/libharfbuzz.0.dylib /opt/homebrew/Cellar/harfbuzz/11.5.1/lib/libharfbuzz.0.arm64.dylib -output /opt/homebrew/Cellar/harfbuzz/11.5.1/lib/libharfbuzz.0.dylib
#
#          mv /opt/homebrew/Cellar/glib/2.86.0/lib/libgobject-2.0.0.dylib /opt/homebrew/Cellar/glib/2.86.0/lib/libgobject-2.0.0.arm64.dylib
#          lipo -create /usr/local/lib/libgobject-2.0.0.dylib /opt/homebrew/Cellar/glib/2.86.0/lib/libgobject-2.0.0.arm64.dylib -output /opt/homebrew/Cellar/glib/2.86.0/lib/libgobject-2.0.0.dylib
#
#          mv /opt/homebrew/Cellar/glib/2.86.0/lib/libglib-2.0.0.dylib /opt/homebrew/Cellar/glib/2.86.0/lib/libglib-2.0.0.arm64.dylib
#          lipo -create /usr/local/lib/libglib-2.0.0.dylib /opt/homebrew/Cellar/glib/2.86.0/lib/libglib-2.0.0.arm64.dylib -output /opt/homebrew/Cellar/glib/2.86.0/lib/libglib-2.0.0.dylib
#
#          mv /opt/homebrew/Cellar/gettext/0.26/lib/libintl.8.dylib /opt/homebrew/Cellar/gettext/0.26/lib/libintl.8.arm64.dylib
#          lipo -create /usr/local/lib/libintl.8.dylib /opt/homebrew/Cellar/gettext/0.26/lib/libintl.8.arm64.dylib -output /opt/homebrew/Cellar/gettext/0.26/lib/libintl.8.dylib
#
#          mv /opt/homebrew/Cellar/pango/1.57.0/lib/libpangocairo-1.0.0.dylib /opt/homebrew/Cellar/pango/1.57.0/lib/libpangocairo-1.0.0.arm64.dylib
#          lipo -create /usr/local/lib/libpangocairo-1.0.0.dylib /opt/homebrew/Cellar/pango/1.57.0/lib/libpangocairo-1.0.0.arm64.dylib -output /opt/homebrew/Cellar/pango/1.57.0/lib/libpangocairo-1.0.0.dylib

      - uses: actions/cache/restore@v4
        id: ccache-cache
        with:
          path: ${{ github.workspace }}/.ccache
          key: ${{ runner.os }}-ccache-${{ needs.check-event.outputs.config }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Set Up Codesigning ðŸ”‘
        uses: ./.github/actions/setup-macos-codesigning
        if: fromJSON(needs.check-event.outputs.codesign)
        id: codesign
        with:
          codesignIdentity: ${{ secrets.MACOS_SIGNING_APPLICATION_IDENTITY }}
          installerIdentity: ${{ secrets.MACOS_SIGNING_INSTALLER_IDENTITY }}
          codesignCertificate: ${{ secrets.MACOS_SIGNING_CERT }}
          certificatePassword: ${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}
          keychainPassword: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
          provisioningProfile: ${{ secrets.MACOS_SIGNING_PROVISIONING_PROFILE }}
          notarizationUser: ${{ secrets.MACOS_NOTARIZATION_USERNAME }}
          notarizationPassword: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}

      - name: Build Plugin ðŸ§±
        uses: ./.github/actions/build-plugin
        with:
          target: macos-15
          config: ${{ needs.check-event.outputs.config }}
          codesign: ${{ fromJSON(needs.check-event.outputs.codesign) }}
          codesignIdent: ${{ steps.codesign.outputs.codesignIdent }}

      - name: Package Plugin ðŸ“€
        uses: ./.github/actions/package-plugin
        with:
          target: macos-15
          config: ${{ needs.check-event.outputs.config }}
          package: ${{ fromJSON(needs.check-event.outputs.package) }}
          codesign: ${{ fromJSON(needs.check-event.outputs.codesign) && fromJSON(steps.codesign.outputs.haveCodesignIdent) }}
          codesignIdent: ${{ steps.codesign.outputs.codesignIdent }}
          installerIdent: ${{ steps.codesign.outputs.installerIdent }}
          codesignTeam: ${{ steps.codesign.outputs.codesignTeam }}
          notarize: ${{ fromJSON(needs.check-event.outputs.notarize) && fromJSON(steps.codesign.outputs.haveNotarizationUser) }}
          codesignUser: ${{ secrets.MACOS_NOTARIZATION_USERNAME }}
          codesignPass: ${{ secrets.MACOS_NOTARIZATION_PASSWORD }}

      - name: Upload Artifacts ðŸ“¡
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-macos-universal-${{ needs.check-event.outputs.commitHash }}
          path: ${{ github.workspace }}/release/${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-macos-universal.*

      - name: Upload Debug Symbol Artifacts ðŸª²
        uses: actions/upload-artifact@v4
        if: ${{ needs.check-event.outputs.config == 'Release' }}
        with:
          name: ${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-macos-universal-${{ needs.check-event.outputs.commitHash }}-dSYMs
          path: ${{ github.workspace }}/release/${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-macos-universal-dSYMs.*

      - uses: actions/cache/save@v4
        if: github.event_name != 'pull_request' && steps.ccache-cache.outputs.cache-hit != 'true'
        with:
          path: ${{ github.workspace }}/.ccache
          key: ${{ runner.os }}-ccache-${{ needs.check-event.outputs.config }}

  ubuntu-build:
    name: Build for Ubuntu ðŸ§
    strategy:
      matrix:
        os: [ubuntu-24.04]
    runs-on: ${{ matrix.os }}
    needs: check-event
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Clone SIMDe
        run: git clone https://github.com/simd-everywhere/simde.git

      - name: Set SIMDe include directory environment variable
        run: echo "SIMDe_include_dir=$(pwd)/simde" >> $GITHUB_ENV

      - name: Set Up Environment ðŸ”§
        id: setup
        run: |
          if [[ "${RUNNER_DEBUG}" ]]; then set -x; fi

          read -r product_name product_version <<< \
            "$(jq -r '. | {name, version} | join(" ")' buildspec.json)"

          echo "pluginName=${product_name}" >> $GITHUB_OUTPUT
          echo "pluginVersion=${product_version}" >> $GITHUB_OUTPUT

      - name: Install Pango dependencies
        run: |
          sudo apt update
          sudo apt install libpango1.0-dev

      - uses: actions/cache/restore@v4
        id: ccache-cache
        with:
          path: ${{ github.workspace }}/.ccache
          key: ${{ runner.os }}-${{ matrix.os }}-ccache-x86_64-${{ needs.check-event.outputs.config }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.os }}-ccache-x86_64-

      - name: Build Plugin ðŸ§±
        uses: ./.github/actions/build-plugin
        with:
          target: x86_64
          config: ${{ needs.check-event.outputs.config }}

      - name: Package Plugin ðŸ“€
        uses: ./.github/actions/package-plugin
        with:
          target: x86_64
          config: ${{ needs.check-event.outputs.config }}
          package: ${{ fromJSON(needs.check-event.outputs.package) }}

      - name: Upload Source Tarball ðŸ—œï¸
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-${{ matrix.os }}-sources-${{ needs.check-event.outputs.commitHash }}
          path: ${{ github.workspace }}/release/${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-source.*

      - name: Upload Artifacts ðŸ“¡
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-${{ matrix.os }}-x86_64-${{ needs.check-event.outputs.commitHash }}
          path: ${{ github.workspace }}/release/${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-x86_64*.*

      - name: Upload debug symbol artifacts ðŸª²
        uses: actions/upload-artifact@v4
        if: ${{ fromJSON(needs.check-event.outputs.package) }}
        with:
          name: ${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-${{ matrix.os }}-x86_64-${{ needs.check-event.outputs.commitHash }}-dbgsym
          path: ${{ github.workspace }}/release/${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-x86_64*-dbgsym.ddeb

      - uses: actions/cache/save@v4
        if: github.event_name != 'pull_request' && steps.ccache-cache.outputs.cache-hit != 'true'
        with:
          path: ${{ github.workspace }}/.ccache
          key: ${{ runner.os }}-${{ matrix.os }}-ccache-x86_64-${{ needs.check-event.outputs.config }}

  windows-build:
    name: Build for Windows ðŸªŸ
    runs-on: windows-2022
    needs: check-event
    env: 
      USERNAME: bkpeterson
      VCPKG_EXE: C:/vcpkg/vcpkg
      FEED_URL: https://nuget.pkg.github.com/bkpeterson/index.json
      VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/bkpeterson/index.json,readwrite"
    defaults:
      run:
        shell: pwsh
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set Up Environment ðŸ”§
        id: setup
        run: |
          if ( $Env:RUNNER_DEBUG -ne $null ) {
            Set-PSDebug -Trace 1
          }

          $BuildSpec = Get-Content -Path buildspec.json -Raw | ConvertFrom-Json
          $ProductName = $BuildSpec.name
          $ProductVersion = $BuildSpec.version

          "pluginName=${ProductName}" >> $env:GITHUB_OUTPUT
          "pluginVersion=${ProductVersion}" >> $env:GITHUB_OUTPUT

      - name: Bootstrap vcpkg
        run: C:/vcpkg/bootstrap-vcpkg.bat

      - name: Add NuGet sources
        run: |
          .$(${{ env.VCPKG_EXE }} fetch nuget) `
            sources add `
            -Source "${{ env.FEED_URL }}" `
            -StorePasswordInClearText `
            -Name GitHubPackages `
            -UserName "${{ env.USERNAME }}" `
            -Password "${{ secrets.GITHUB_TOKEN }}"
          .$(${{ env.VCPKG_EXE }} fetch nuget) `
            setapikey "${{ secrets.GITHUB_TOKEN }}" `
            -Source "${{ env.FEED_URL }}"

      - name: Download and Install Pango
        run: |
          vcpkg update
          vcpkg integrate install
          vcpkg install pango

      - name: Build Plugin ðŸ§±
        uses: ./.github/actions/build-plugin
        with:
          target: x64
          config: ${{ needs.check-event.outputs.config }}

      - name: Package Plugin ðŸ“€
        uses: ./.github/actions/package-plugin
        with:
          target: x64
          config: ${{ needs.check-event.outputs.config }}
          package: ${{ fromJSON(needs.check-event.outputs.package) }}

      - name: Upload Artifacts ðŸ“¡
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-windows-x64-${{ needs.check-event.outputs.commitHash }}
          path: ${{ github.workspace }}/release/${{ steps.setup.outputs.pluginName }}-${{ steps.setup.outputs.pluginVersion }}-windows-x64*.*
